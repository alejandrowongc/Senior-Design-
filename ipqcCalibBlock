#!/usr/bin/env python3
import cv2
import numpy as np
from picamera2 import Picamera2
import time

# ---------------- Camera Setup ----------------
picam2 = Picamera2()
config = picam2.create_preview_configuration(main={"size": (800, 480)})
picam2.configure(config)
picam2.start()
time.sleep(2)

# Lock exposure and white balance
picam2.set_controls({"AwbEnable": False, "AeEnable": False})
picam2.set_controls({"AwbMode": 0, "ColourGains": (1.8, 1.0)})

# ROI definition
ROI_X1, ROI_Y1, ROI_X2, ROI_Y2 = 10, 175, 790, 325
ROI_CENTER_X = (ROI_X1 + ROI_X2) // 2

# Measurement constants
PIXELS_PER_INCH = 42.0
TARGET_LENGTH = 3.0
TOL = 0.125
LOW_LIMIT = TARGET_LENGTH - TOL
HIGH_LIMIT = TARGET_LENGTH + TOL

# Tracking state
state = "IDLE"        # IDLE, TRACKING, DECIDED
saved_result = None   # PASS/REJECT after crossing center
saved_length = None
last_seen_x = None    # Used to ensure object is moving left

print("Press 'q' to quit")

while True:
    frame = picam2.capture_array()
    frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

    # Draw ROI
    cv2.rectangle(frame_rgb, (ROI_X1, ROI_Y1), (ROI_X2, ROI_Y2), (255, 0, 0), 2)
    roi = frame_rgb[ROI_Y1:ROI_Y2, ROI_X1:ROI_X2]

    # Edge detection
    gray = cv2.cvtColor(roi, cv2.COLOR_RGB2GRAY)
    blur = cv2.GaussianBlur(gray, (5, 5), 0)
    edges = cv2.Canny(blur, 50, 150)
    edges = cv2.morphologyEx(edges, cv2.MORPH_CLOSE, np.ones((3,3), np.uint8))

    contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    valid_cnt = None
    best_area = 0

    # Select largest valid contour (reduces false pickups)
    for cnt in contours:
        area = cv2.contourArea(cnt)
        if 1000 < area < 15000 and area > best_area:
            valid_cnt = cnt
            best_area = area

    if valid_cnt is None:
        # No object detected
        if state != "IDLE":
            # Object fully left the frame â†’ reset
            state = "IDLE"
            saved_result = None
            saved_length = None
            last_seen_x = None
        cv2.imshow("Full Frame (ROI Marked)", frame_rgb)
        if cv2.waitKey(1) & 0xFF == 'q':
            break
        continue

    # Bounding box and centroid
    x, y, w, h = cv2.boundingRect(valid_cnt)
    cx = x + w // 2
    cy = y + h // 2
    cv2.circle(roi, (cx, cy), 3, (255, 255, 0), -1)

    # Compute measurement
    length_pixels = max(w, h)
    length_inches = length_pixels / PIXELS_PER_INCH

    # Determine flow direction: object must be entering from the right
    if last_seen_x is None:
        last_seen_x = cx
    moving_left = cx < last_seen_x
    last_seen_x = cx

    # ---------------- STATE MACHINE ----------------
    if state == "IDLE":
        # Require object to enter from right side (cx > midline)
        if cx > ROI_CENTER_X:
            state = "TRACKING"

    elif state == "TRACKING":
        # Update measurement display
        cv2.putText(roi, f"{length_inches:.3f} in", (x, y - 10),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255,255,255), 2)

        # When center crosses ROI center, lock the decision
        if cx <= ROI_CENTER_X and moving_left:
            if LOW_LIMIT <= length_inches <= HIGH_LIMIT:
                saved_result = "PASS"
                color = (0,255,0)
            else:
                saved_result = "REJECT"
                color = (0,0,255)
            saved_length = length_inches
            state = "DECIDED"

    elif state == "DECIDED":
        # Freeze result until object exits left
        color = (0,255,0) if saved_result == "PASS" else (0,0,255)

        cv2.putText(roi, f"{saved_length:.3f} in", (x, y - 10),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255,255,255), 2)

        cv2.putText(roi, saved_result, (x, y + h + 20),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.7, color, 2)

        # Stay in DECIDED until object leaves on left (cx < 0)
        # but since we're in ROI coords: x < -w
        # but we detect exit earlier by valid_cnt == None

    # Draw bounding box (visual only)
    cv2.rectangle(roi, (x, y), (x + w, y + h),
                  (0,255,0) if state=="DECIDED" and saved_result=="PASS" else
                  (0,0,255) if state=="DECIDED" else (255,255,255), 2)

    # Show frame
    cv2.imshow("Full Frame (ROI Marked)", frame_rgb)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cv2.destroyAllWindows()
picam2.stop()
